name: CI

on:
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  lint-build-test:
    name: Lint, Build & Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - run: npm ci

      - name: Lint
        run: npm run lint

      - name: Type check
        run: npm run typecheck

      - name: Build
        run: npm run build
        env:
          NODE_ENV: production

      - name: Test
        run: npm run test:run

  balance-simulation:
    name: Balance Simulation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - run: npm ci

      - name: Run balance simulation (PR branch)
        id: sim-pr
        run: |
          set +e
          NO_COLOR=1 npx vitest run balance-sim --reporter=verbose 2>&1 | tee /tmp/balance-sim-pr.txt
          echo "exit_code=${PIPESTATUS[0]}" >> "$GITHUB_OUTPUT"

      - name: Run balance simulation (main branch)
        id: sim-main
        run: |
          set +e
          git fetch origin main --depth=1
          if git worktree add /tmp/main-branch origin/main 2>/dev/null; then
            cd /tmp/main-branch
            npm ci
            NO_COLOR=1 npx vitest run balance-sim --reporter=verbose 2>&1 | tee /tmp/balance-sim-main.txt
            cd "$GITHUB_WORKSPACE"
            git worktree remove /tmp/main-branch --force 2>/dev/null
          fi
          exit 0

      - name: Parse and compare simulation results
        if: always()
        run: |
          python3 << 'PYEOF'
          import re, json

          def parse_sim(filepath):
              try:
                  with open(filepath) as f:
                      raw = f.read()
              except FileNotFoundError:
                  return {}, ''
              raw = re.sub(r'\x1b\[[0-9;]*m', '', raw)
              tiers = {}
              for m in re.finditer(
                  r'BALANCE SIMULATION\s*\W+\s*(\w+).*?(\d+)/(\d+)\s+goals within bounds',
                  raw,
                  re.DOTALL,
              ):
                  name, passed, total = m.group(1), int(m.group(2)), int(m.group(3))
                  tiers[name.upper()] = {'name': name.title(), 'passed': passed, 'total': total}
              blocks = re.findall(r'(={10,}.*?={10,}.*?={10,})', raw, re.DOTALL)
              tables = '\n\n'.join(blocks) if blocks else raw
              return tiers, tables

          pr_tiers, pr_tables = parse_sim('/tmp/balance-sim-pr.txt')
          main_tiers, main_tables = parse_sim('/tmp/balance-sim-main.txt')

          TIER_ORDER = ['HAMLET','VILLAGE','TOWN','CITY','COUNTY','DUCHY','REALM','KINGDOM']
          all_keys = sorted(
              set(list(pr_tiers.keys()) + list(main_tiers.keys())),
              key=lambda k: TIER_ORDER.index(k) if k in TIER_ORDER else 99,
          )

          rows = []
          pr_total_passed = 0
          pr_total_goals = 0
          main_total_passed = 0
          main_total_goals = 0

          for key in all_keys:
              pr = pr_tiers.get(key)
              main = main_tiers.get(key)
              name = (pr or main)['name']

              if pr:
                  pr_total_passed += pr['passed']
                  pr_total_goals += pr['total']
                  pr_icon = '✅' if pr['passed'] == pr['total'] else '⚠️'
                  pr_str = f"{pr['passed']}/{pr['total']} {pr_icon}"
              else:
                  pr_str = '—'

              if main:
                  main_total_passed += main['passed']
                  main_total_goals += main['total']
                  main_icon = '✅' if main['passed'] == main['total'] else '⚠️'
                  main_str = f"{main['passed']}/{main['total']} {main_icon}"
              else:
                  main_str = '—'

              if pr and main:
                  delta = pr['passed'] - main['passed']
                  if delta > 0:
                      delta_str = f'**+{delta}**'
                  elif delta < 0:
                      delta_str = f'**{delta}**'
                  else:
                      delta_str = '—'
              else:
                  delta_str = 'new' if pr and not main else 'removed'

              rows.append(f'| {name} | {pr_str} | {main_str} | {delta_str} |')

          has_main = len(main_tiers) > 0
          total_delta = pr_total_passed - main_total_passed

          if has_main:
              if total_delta > 0:
                  overall = f'**{pr_total_passed}/{pr_total_goals}** goals in bounds (improved by {total_delta} vs main)'
              elif total_delta < 0:
                  overall = f'**{pr_total_passed}/{pr_total_goals}** goals in bounds (regressed by {abs(total_delta)} vs main)'
              else:
                  overall = f'**{pr_total_passed}/{pr_total_goals}** goals in bounds (no change vs main)'
          else:
              overall = f'**{pr_total_passed}/{pr_total_goals}** goals in bounds'

          max_len = 25000
          if len(pr_tables) > max_len:
              pr_tables = pr_tables[:max_len] + '\n... (truncated)'
          if len(main_tables) > max_len:
              main_tables = main_tables[:max_len] + '\n... (truncated)'

          result = {
              'overall': overall,
              'rows': '\n'.join(rows),
              'pr_tables': pr_tables,
              'main_tables': main_tables,
              'has_main': has_main,
              'total_delta': total_delta,
              'all_pass': pr_total_passed == pr_total_goals,
          }

          with open('/tmp/sim-comparison.json', 'w') as f:
              json.dump(result, f)
          PYEOF

      - name: Post simulation results to PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let data;
            try {
              data = JSON.parse(fs.readFileSync('/tmp/sim-comparison.json', 'utf8'));
            } catch {
              data = null;
            }

            const marker = '<!-- balance-simulation-results -->';

            if (!data) {
              const body = [
                marker,
                '## ⚠️ Balance Simulation Results',
                '',
                'Simulation output could not be parsed. Check the workflow logs.',
              ].join('\n');

              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });
              const existing = comments.find(c => c.body?.includes(marker));
              if (existing) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: existing.id,
                  body,
                });
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body,
                });
              }
              return;
            }

            const icon = data.total_delta < 0 ? '❌' : data.all_pass ? '✅' : '⚠️';

            const sections = [
              marker,
              `## ${icon} Balance Simulation Results`,
              '',
              data.overall,
              '',
              '| Tier | PR | main | Change |',
              '|------|-----|------|--------|',
              data.rows,
            ];

            // PR branch details
            sections.push(
              '',
              '<details>',
              '<summary>Full simulation output (PR branch)</summary>',
              '',
              '```',
              data.pr_tables || 'No output captured.',
              '```',
              '',
              '</details>',
            );

            // main branch details (only if we got results)
            if (data.has_main) {
              sections.push(
                '',
                '<details>',
                '<summary>Full simulation output (main)</summary>',
                '',
                '```',
                data.main_tables || 'No output captured.',
                '```',
                '',
                '</details>',
              );
            }

            const body = sections.join('\n');

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const existing = comments.find(c => c.body?.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }
